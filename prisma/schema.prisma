// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// SQLite compatible version - Enums and Json are stored as Strings

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Multi-Tenant Core Models
// ============================================

// Note: SQLite doesn't support enums, so we use String with constraints
// UserRole: "SuperAdmin" | "AgencyUser" | "ClientUser"
// UserStatus: "active" | "inactive" | "pending"
// CompanyStatus: "Active" | "Archived"
// ModuleStatus: "installed" | "active" | "inactive" | "error"

model User {
  id            String      @id @default(uuid())
  name          String
  username      String?     @unique // Kullanıcı adı (giriş için)
  email         String      @unique
  password      String?     // Hashed password
  role          String      @default("ClientUser") // UserRole enum as String
  status        String      @default("pending") // UserStatus enum as String
  agencyId      String?
  
  // Personal Information
  phone         String?
  profilePicture String?
  department    String?
  position      String?
  employeeId    String?
  hireDate      DateTime?
  
  // Contact Information
  address       String?
  city          String?
  country       String?
  postalCode    String?
  emergencyContact String?
  emergencyPhone String?
  
  // Documents
  passportUrl   String?
  idCardUrl     String?
  contractUrl   String?
  cvUrl         String?
  otherDocuments String?   // JSON string: Array of document URLs
  
  // Preferences
  defaultLanguage String?   @default("tr")
  defaultTheme    String?   @default("auto")
  defaultLayout   String?   @default("sidebar")
  
  // Timestamps
  lastActive    DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Relations
  agency        Agency?    @relation(fields: [agencyId], references: [id], onDelete: SetNull)
  companies     Company[]  @relation("CompanyUsers")
  userPreferences UserPreferences?
  userPermissions UserPermission[]
  aiGenerations AIGeneration[]
  aiHistory     AIHistory[]
  sentNotifications Notification[] @relation("NotificationSender")
  receivedNotifications Notification[] @relation("NotificationRecipient")
  reports       Report[]
  
  @@index([email])
  @@index([username])
  @@index([role])
  @@index([status])
  @@index([agencyId])
}

model Agency {
  id          String   @id @default(uuid())
  name        String
  email       String?  @unique
  phone       String?
  address     String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  companies   Company[]
  
  @@index([name])
}

model Company {
  id          String        @id @default(uuid())
  name        String
  industry    String?
  website     String?
  status      String        @default("Active") // CompanyStatus enum as String
  agencyId    String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  agency      Agency?       @relation(fields: [agencyId], references: [id], onDelete: SetNull)
  users       User[]        @relation("CompanyUsers")
  brandKit    BrandKit?
  assets      Asset[]
  contents    Content[]
  finances    Finance[]
  aiGenerations AIGeneration[]
  aiHistory   AIHistory[]
  layoutConfig CompanyLayoutConfig?
  websites    Website[]
  
  @@index([name])
  @@index([status])
  @@index([agencyId])
}

model BrandKit {
  id            String   @id @default(uuid())
  companyId     String   @unique
  logoUrl       String?
  colorPalette  String?  // JSON string: { primary: "#...", secondary: "#...", etc. }
  fontFamily    String?
  toneOfVoice   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
}

model Asset {
  id          String   @id @default(uuid())
  companyId   String
  url         String
  tags        String?  // JSON string: Array of tag strings
  name        String?
  description String?
  fileType    String?
  fileSize    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
}

model Content {
  id            String    @id @default(uuid())
  companyId     String
  status        String    // draft, scheduled, published, archived
  caption       String?
  mediaUrl      String?
  scheduledDate DateTime?
  publishedDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([status])
  @@index([scheduledDate])
}

model Finance {
  id          String   @id @default(uuid())
  companyId   String
  amount      Float    // SQLite doesn't support Decimal, use Float
  type        String   // income, expense, etc.
  description String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([type])
  @@index([date])
}

// ============================================
// Module System
// ============================================

model Module {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  version     String
  description String?
  icon        String?
  author      String?
  path        String?      // Directory path
  status      String       @default("installed") // ModuleStatus enum as String
  metadata    String?      // JSON string: Additional metadata
  settings    String?      // JSON string: Module settings
  installedAt DateTime?
  activatedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  modulePermissions ModulePermission[]
  
  @@index([slug])
  @@index([status])
}

model ModulePermission {
  id        String   @id @default(uuid())
  moduleId  String
  role      String   // UserRole enum as String
  canAccess Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@unique([moduleId, role])
  @@index([moduleId])
  @@index([role])
}

// ============================================
// Permission System
// ============================================

model PermissionDefinition {
  id            String   @id @default(uuid())
  permissionKey String   @unique // Format: "module.action"
  permissionName String
  description   String?
  category      String?
  module        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  userPermissions UserPermission[]
  
  @@index([permissionKey])
  @@index([category])
  @@index([module])
}

model UserPermission {
  id          String    @id @default(uuid())
  userId      String
  permissionKey String
  granted     Boolean   @default(false)
  grantedBy   String?
  grantedAt   DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission  PermissionDefinition @relation(fields: [permissionKey], references: [permissionKey], onDelete: Cascade)
  
  @@index([userId])
  @@index([permissionKey])
  @@index([granted])
}

model PagePermission {
  id                String    @id @default(uuid())
  pageRoute         String    @unique
  pageName          String
  description       String?
  requiredRole      String?   // UserRole enum as String
  requiredPermissions String? // JSON string: Array of permission keys
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([pageRoute])
  @@index([requiredRole])
}

// ============================================
// User Preferences
// ============================================

// Note: SQLite doesn't support enums
// LayoutType: "SidebarLayout" | "TopLayout"
// ThemeMode: "Light" | "Dark" | "Auto"
// Direction: "LTR" | "RTL"

model UserPreferences {
  id                String      @id @default(uuid())
  userId            String      @unique
  layoutType        String      @default("SidebarLayout") // LayoutType enum as String
  themeMode         String      @default("Auto") // ThemeMode enum as String
  direction         String      @default("LTR") // Direction enum as String
  locale            String      @default("tr")
  sidebarBackground String?     // Color or preset name
  sidebarCollapsed  Boolean     @default(false)
  sidebarWidth      Int?        @default(260) // px
  footerVisible     Boolean     @default(true)
  topBarScroll      String?     // fixed, hidden, hidden-on-hover
  menuColor         String?     // light, dark
  customCss         String?
  preferences       String?     // JSON string: Additional preferences
  
  // Yeni layout ayarları (v2)
  layoutConfig      String?     // JSON: Tüm layout yapılandırması
  sidebarConfig     String?     // JSON: Sidebar özelleştirmeleri
  topConfig         String?     // JSON: Top layout özelleştirmeleri
  mobileConfig      String?     // JSON: Mobil özelleştirmeleri
  contentAreaConfig String?     // JSON: İçerik alanı ayarları
  layoutSource      String?     // "role" | "user" | "company" | "default"
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// ============================================
// AI System
// ============================================

// Note: SQLite doesn't support enums
// GeneratorType: "text" | "code" | "image" | "voice" | "video"

model AIGeneration {
  id            String        @id @default(uuid())
  userId        String
  companyId     String?
  generatorType String        // GeneratorType enum as String
  prompt        String        // Long text field
  output        String?       // Long text field: text/url/json
  settings      String?       // JSON string: Generation settings
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([companyId])
  @@index([generatorType])
  @@index([createdAt])
}

model AIHistory {
  id            String        @id @default(uuid())
  userId        String
  companyId     String?
  generatorType String        // GeneratorType enum as String
  prompt        String        // Long text field
  outputUrl     String?
  metadata      String?       // JSON string
  createdAt     DateTime      @default(now())
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([companyId])
  @@index([generatorType])
  @@index([createdAt])
}

// ============================================
// Notification System
// ============================================

// Note: SQLite doesn't support enums
// NotificationType: "info" | "warning" | "error" | "success" | "task" | "alert"
// NotificationPriority: "low" | "medium" | "high" | "urgent"
// NotificationStatus: "read" | "unread" | "archived"

model Notification {
  id          String            @id @default(uuid())
  title       String
  message     String            // Long text field
  type        String            @default("info") // NotificationType enum as String
  priority    String            @default("medium") // NotificationPriority enum as String
  senderId    String?
  recipientId String?
  locationId  String?
  isRead      Boolean           @default(false)
  readAt      DateTime?
  isGlobal    Boolean           @default(false)
  expiresAt   DateTime?
  data        String?           // JSON string: Additional data
  actionUrl   String?
  actionText  String?
  module      String?
  archivedAt  DateTime?
  status      String?           // Computed: "read" | "unread" | "archived" (derived from isRead and archivedAt)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Relations
  sender      User?             @relation("NotificationSender", fields: [senderId], references: [id], onDelete: SetNull)
  recipient   User?             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  attachments Attachment[]
  
  @@index([senderId])
  @@index([recipientId])
  @@index([isRead])
  @@index([status])
  @@index([isGlobal])
  @@index([type])
  @@index([module])
  @@index([archivedAt])
  @@index([createdAt])
}

model Attachment {
  id          String         @id @default(uuid())
  notificationId String
  url         String
  filename    String
  contentType String?
  size        Int?           // File size in bytes
  companyId   String?
  createdAt   DateTime       @default(now())
  
  // Relations
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  
  @@index([notificationId])
  @@index([companyId])
}

// ============================================
// Report System
// ============================================

// Note: SQLite doesn't support enums
// ReportStatus: "pending" | "completed" | "failed" | "generating"

model Report {
  id            String        @id @default(uuid())
  userId        String
  name          String
  reportType    String
  description   String?
  dateRange     String?       // JSON string: { start: Date, end: Date }
  filters       String?       // JSON string: Additional filters
  visualization String?       // table, bar, line, pie, area
  status        String        @default("pending") // ReportStatus enum as String
  outputUrl     String?
  errorMessage  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([reportType])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Role System (if needed separately)
// ============================================

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions String?  // JSON string: Array of permission keys
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  layoutConfig RoleLayoutConfig?
  
  @@index([name])
}

// ============================================
// Layout Configuration Models (v2)
// ============================================

model RoleLayoutConfig {
  id            String   @id @default(uuid())
  role          String   @unique  // UserRole
  layoutType    String   @default("sidebar")
  config        String?  // JSON: Layout yapılandırması
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  roleRef       Role     @relation(fields: [role], references: [name], onDelete: Cascade)
  
  @@index([role])
}

model CompanyLayoutConfig {
  id            String   @id @default(uuid())
  companyId     String   @unique
  layoutType    String   @default("sidebar")
  config        String?  // JSON: Layout yapılandırması
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
}

// ============================================
// Web Builder Module
// ============================================

model Website {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  domain      String?  @unique
  subdomain   String?  @unique // e.g. site.omnex.com
  status      String   @default("draft") // draft, published, archived
  favicon     String?
  metaTitle   String?
  metaDesc    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pages       Page[]
  theme       Theme?
  assets      WebsiteAsset[]
  forms       Form[]
  
  @@index([companyId])
  @@index([domain])
  @@index([subdomain])
}

model Page {
  id          String   @id @default(uuid())
  websiteId   String
  title       String
  slug        String
  status      String   @default("draft") // draft, published
  isHome      Boolean  @default(false)
  metaTitle   String?
  metaDesc    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  website     Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  sections    PageSection[]
  
  @@unique([websiteId, slug])
  @@index([websiteId])
}

model PageSection {
  id          String   @id @default(uuid())
  pageId      String
  type        String   // hero, features, contact, etc.
  order       Int
  settings    String?  // JSON: background, padding, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  elements    PageElement[]
  
  @@index([pageId])
  @@index([order])
}

model PageElement {
  id          String   @id @default(uuid())
  sectionId   String
  type        String   // text, image, button, video, etc.
  content     String?  // JSON or text content
  settings    String?  // JSON: styles, animation, etc.
  order       Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  section     PageSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  @@index([sectionId])
  @@index([order])
}

model Theme {
  id          String   @id @default(uuid())
  websiteId   String   @unique
  name        String?
  config      String   // JSON: colors, typography, spacing, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  website     Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
}

model Template {
  id          String   @id @default(uuid())
  name        String
  description String?
  thumbnail   String?
  category    String?
  structure   String   // JSON: Full page/site structure
  isPublic    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
}

model Form {
  id          String   @id @default(uuid())
  websiteId   String
  name        String
  fields      String   // JSON: Form fields definition
  settings    String?  // JSON: Email notifications, success message, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  website     Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
  
  @@index([websiteId])
}

model FormSubmission {
  id          String   @id @default(uuid())
  formId      String
  data        String   // JSON: Submitted data
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  @@index([formId])
}

model WebsiteAsset {
  id          String   @id @default(uuid())
  websiteId   String
  url         String
  name        String?
  type        String?  // image, document, video
  size        Int?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  website     Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  
  @@index([websiteId])
}
